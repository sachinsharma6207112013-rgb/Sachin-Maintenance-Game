<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack – Smart Student Record Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Subtle Page Gradient: Light Cyan to White */
            background: linear-gradient(to bottom right, #f0f9ff, #ffffff);
        }
        /* Custom Text Gradient for Header: Teal to Violet */
        .text-gradient {
            background-color: #06b6d4; /* Fallback */
            background-image: linear-gradient(to right, #06b6d4, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <div id="app" class="container mx-auto p-4 sm:p-8">
        <!-- Header -->
        <header class="text-center py-8 bg-white shadow-xl rounded-xl mb-8 border-b-4 border-cyan-500">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gradient">EduTrack</h1>
            <p class="text-lg text-gray-500 mt-2">Smart Student Record Manager</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Management Panel (Left - Col 1) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Add/Edit Student Form Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-cyan-100">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4" id="formTitle">Add New Student</h2>
                    <form id="studentForm" class="space-y-4">
                        <input type="hidden" id="studentId">
                        
                        <div>
                            <label for="rollNo" class="block text-sm font-medium text-gray-700">Roll No (Unique)</label>
                            <input type="number" id="rollNo" required min="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Student Name</label>
                            <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="mathsMarks" class="block text-sm font-medium text-gray-700">Maths Marks (0-100)</label>
                                <input type="number" id="mathsMarks" required min="0" max="100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                            <div>
                                <label for="attendance" class="block text-sm font-medium text-gray-700">Attendance (%)</label>
                                <input type="number" id="attendance" required min="0" max="100" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                            </div>
                        </div>
                        
                        <div>
                            <label for="contact" class="block text-sm font-medium text-gray-700">Contact Email</label>
                            <input type="email" id="contact" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-cyan-500 focus:border-cyan-500">
                        </div>
                        
                        <div class="flex space-x-2 pt-2">
                            <!-- Save/Update Button Gradient: Cyan to Teal -->
                            <button type="submit" id="saveBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-gradient-to-r from-cyan-500 to-teal-500 hover:from-cyan-600 hover:to-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400 transition duration-150 transform hover:scale-[1.01]">
                                Save Record
                            </button>
                            <button type="button" id="cancelEditBtn" class="py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150 hidden" onclick="resetForm()">
                                Cancel
                            </button>
                        </div>
                        <p id="authStatus" class="text-xs text-center text-red-500 mt-2">Initializing...</p>
                        <p id="userIdDisplay" class="text-xs text-center text-gray-400">User ID: N/A</p>
                    </form>
                </div>

                <!-- Report and Demo Card -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Analytics & Demo</h2>
                    <div class="space-y-3">
                        <!-- Toppers Button Gradient: Violet to Indigo -->
                        <button onclick="generateReport('toppers')" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 transform hover:scale-[1.01]">
                            Generate Top 5 Toppers' List
                        </button>
                        <!-- Demo Button Gradient: Orange to Red -->
                        <button onclick="runAlgorithmDemo()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-400 transition duration-150 transform hover:scale-[1.01]">
                            Run Algorithm Efficiency Demo
                        </button>
                    </div>
                    <div id="demoOutput" class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm whitespace-pre-wrap text-gray-700 min-h-20">
                        *Results of reports, demos, or AI analysis will appear here.*
                    </div>
                </div>
            </div>

            <!-- Student Data Table (Right - Col 2/3) -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-green-100">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Student Records</h2>
                    
                    <!-- Search Bar -->
                    <div class="mb-4">
                        <input type="text" id="searchQuery" oninput="searchStudents()" placeholder="Instant search by Name, Roll No, or Grade..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <p class="text-xs text-gray-500 mt-1">
                            *This search currently uses a Linear Search for simplicity, fulfilling the 'Instant Search' feature.
                        </p>
                    </div>

                    <!-- Table Container (Responsive Scroll) -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Maths Marks</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance (%)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Student records will be populated here -->
                                <tr><td colspan="6" class="p-4 text-center text-gray-500">Loading student records...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p id="recordCount" class="text-sm text-gray-600 mt-4">Total Records: 0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, getDocs, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Gemini API Configuration ---
        const GEMINI_API_KEY = ""; // Canvas will provide this key at runtime
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        // --- End Gemini API Configuration ---
        
        // Use the Canvas provided globals
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'edutrack-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* default config */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Set Firebase Log Level for debugging
        setLogLevel('debug');

        // Global Firebase instances
        let app;
        let db;
        let auth;
        let userId = 'default-user'; // Placeholder
        let allStudents = []; // Array to hold all student data for client-side search/sort

        const AUTH_STATUS = document.getElementById('authStatus');
        const USER_ID_DISPLAY = document.getElementById('userIdDisplay');

        // 1. Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                AUTH_STATUS.textContent = 'Authenticating...';

                // Sign in using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        AUTH_STATUS.textContent = 'Authenticated successfully!';
                        AUTH_STATUS.classList.remove('text-red-500');
                        AUTH_STATUS.classList.add('text-green-600');
                        USER_ID_DISPLAY.textContent = `User ID: ${userId}`;
                        setupRealtimeListener();
                    } else {
                        AUTH_STATUS.textContent = 'Authentication failed. Data will not be saved.';
                        USER_ID_DISPLAY.textContent = `User ID: N/A`;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                AUTH_STATUS.textContent = `Error: ${error.message}`;
                AUTH_STATUS.classList.remove('text-green-600');
                AUTH_STATUS.classList.add('text-red-500');
            }
        }

        // 2. Data Persistence (Firestore) Setup
        function getCollectionPath() {
            // Using a private collection for student records
            return `artifacts/${appId}/users/${userId}/student_records`;
        }

        // 3. Real-time Data Listener (Read)
        function setupRealtimeListener() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const q = collection(db, getCollectionPath());

            onSnapshot(q, (snapshot) => {
                const students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                allStudents = students; // Update global student array
                renderStudents(allStudents); // Render all data initially
            }, (error) => {
                console.error("Error listening to student records:", error);
                document.getElementById('studentTableBody').innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Error loading data. Check console.</td></tr>';
            });
        }

        // 4. CRUD Operations

        // Add/Update Student
        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !userId) {
                console.error("Cannot save: DB or User ID not ready.");
                return;
            }

            const studentId = document.getElementById('studentId').value;
            const rollNo = parseInt(document.getElementById('rollNo').value);
            const name = document.getElementById('name').value.trim();
            const mathsMarks = parseInt(document.getElementById('mathsMarks').value);
            const attendance = parseInt(document.getElementById('attendance').value);
            const contact = document.getElementById('contact').value.trim();
            
            // Validation
            if (mathsMarks < 0 || mathsMarks > 100) {
                 showMessage("Maths Marks must be between 0 and 100.", 'error');
                 return;
            }
            if (attendance < 0 || attendance > 100) {
                 showMessage("Attendance must be between 0 and 100.", 'error');
                 return;
            }

            const studentData = {
                rollNo,
                name,
                mathsMarks,
                attendance,
                contact,
                timestamp: serverTimestamp(),
                // Calculate grade for search/sorting demonstration
                grade: mathsMarks >= 90 ? 'A' : (mathsMarks >= 80 ? 'B' : (mathsMarks >= 70 ? 'C' : 'D'))
            };

            const docRef = studentId ? doc(db, getCollectionPath(), studentId) : doc(collection(db, getCollectionPath()));

            try {
                if (!studentId) {
                    // Check for existing Roll No during ADD operation
                    const rollNoExists = allStudents.some(s => s.rollNo === rollNo);
                    if (rollNoExists) {
                        showMessage(`Roll No ${rollNo} already exists.`, 'error');
                        return;
                    }
                }
                
                await setDoc(docRef, studentData, { merge: true });
                showMessage(studentId ? 'Record updated successfully!' : 'Record added successfully!', 'success');
                resetForm();
            } catch (error) {
                console.error("Error adding/updating document:", error);
                showMessage('Failed to save record. Check console for details.', 'error');
            }
        });

        // Delete Student
        window.deleteStudent = async (id, name) => {
            if (!db || !userId) return;

            // Use a custom message box instead of alert/confirm
            showConfirmation(`Are you sure you want to delete the record for ${name}?`, async () => {
                try {
                    await deleteDoc(doc(db, getCollectionPath(), id));
                    showMessage(`Record for ${name} deleted.`, 'success');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showMessage('Failed to delete record. Check console.', 'error');
                }
            });
        };

        // Edit Student (Load data into form)
        window.editStudent = (id) => {
            const student = allStudents.find(s => s.id === id);
            if (!student) return;

            document.getElementById('studentId').value = student.id;
            document.getElementById('rollNo').value = student.rollNo;
            document.getElementById('name').value = student.name;
            document.getElementById('mathsMarks').value = student.mathsMarks;
            document.getElementById('attendance').value = student.attendance;
            document.getElementById('contact').value = student.contact;

            document.getElementById('formTitle').textContent = `Edit Student: ${student.name}`;
            document.getElementById('saveBtn').textContent = 'Update Record';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
        };

        window.resetForm = () => {
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Student';
            document.getElementById('saveBtn').textContent = 'Save Record';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        };

        // 5. Search Functionality (Demonstrating Linear Search)
        window.searchStudents = () => {
            const queryText = document.getElementById('searchQuery').value.toLowerCase().trim();
            if (!queryText) {
                renderStudents(allStudents); // Show all if query is empty
                return;
            }

            // --- Demonstration of Linear Search ---
            const filteredStudents = [];
            const startTime = performance.now();
            
            for (const student of allStudents) {
                const searchString = `${student.rollNo} ${student.name} ${student.grade} ${student.contact}`.toLowerCase();
                if (searchString.includes(queryText)) {
                    filteredStudents.push(student);
                }
            }
            
            const endTime = performance.now();
            console.log(`Linear Search completed in: ${(endTime - startTime).toFixed(3)}ms for ${allStudents.length} records.`);
            // --- End of Linear Search Demo ---

            renderStudents(filteredStudents);
        };

        // 6. Rendering Logic
        function renderStudents(studentsToRender) {
            const tbody = document.getElementById('studentTableBody');
            const recordCount = document.getElementById('recordCount');
            tbody.innerHTML = '';
            recordCount.textContent = `Total Records: ${allStudents.length} (Showing: ${studentsToRender.length})`;

            if (studentsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No records found.</td></tr>';
                return;
            }

            studentsToRender.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-cyan-50 transition duration-100'; /* Updated hover color */
                tr.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.rollNo}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${student.name}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">
                        ${student.mathsMarks} 
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${student.grade === 'A' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${student.grade}
                        </span>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${student.attendance}%</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm text-cyan-600">${student.contact}</td>
                    <td class="px-3 py-3 whitespace-nowrap text-sm font-medium flex space-x-2">
                        <button onclick="editStudent('${student.id}')" class="text-violet-600 hover:text-violet-900 focus:outline-none">Edit</button>
                        <button onclick="deleteStudent('${student.id}', '${student.name}')" class="text-red-600 hover:text-red-900 focus:outline-none">Delete</button>
                        <!-- Draft Report Button Gradient: Pink to Magenta -->
                        <button onclick="draftPerformanceReport('${student.id}')" class="text-white hover:text-white focus:outline-none flex items-center text-xs px-2 py-1 rounded-lg bg-gradient-to-r from-pink-500 to-fuchsia-600 hover:from-pink-600 hover:to-fuchsia-700 transition duration-150 transform hover:scale-[1.05]">
                            Draft Report ✨
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 7. Report Generation (Sort + Display)
        window.generateReport = (type) => {
            const output = document.getElementById('demoOutput');
            output.textContent = "Generating Toppers' List...";

            if (type === 'toppers') {
                if (allStudents.length === 0) {
                    output.textContent = "No records to generate a report.";
                    return;
                }
                
                // Sorting by marks (demonstrates client-side sorting)
                const sortedStudents = [...allStudents].sort((a, b) => b.mathsMarks - a.mathsMarks);
                const topStudents = sortedStudents.slice(0, 5);
                
                let report = "--- Top 5 Toppers (Sorted by Maths Marks) ---\n";
                topStudents.forEach((student, index) => {
                    report += `${index + 1}. ${student.name} (Roll No: ${student.rollNo}) - Marks: ${student.mathsMarks}\n`;
                });
                
                output.textContent = report;
            }
        };

        // 8. Algorithm Efficiency Demo
        window.runAlgorithmDemo = () => {
            const output = document.getElementById('demoOutput');
            const dataSize = allStudents.length;
            
            if (dataSize < 10) {
                output.textContent = `Need at least 10 records to demonstrate efficiency. Current records: ${dataSize}`;
                return;
            }

            const dataArray = allStudents.map(s => s.mathsMarks);
            let demoReport = `--- Algorithm Efficiency Demo ---\nData Size: ${dataSize} records (using Maths Marks)\n\n`;

            // --- Bubble Sort Demo ---
            const bubbleSortTime = timeSort(dataArray, bubbleSort);
            demoReport += `1. Bubble Sort: ${bubbleSortTime.toFixed(3)}ms\n`;

            // --- Quick Sort Demo ---
            // Note: Use a copy of the array for Quick Sort to prevent modifying the original or bubble sorted array
            const quickSortTime = timeSort(dataArray, (arr) => quickSort([...arr]));
            demoReport += `2. Quick Sort: ${quickSortTime.toFixed(3)}ms (Typically much faster)\n\n`;
            
            demoReport += `*This demonstrates how Quick Sort (O(n log n)) is much faster than Bubble Sort (O(n^2)) for sorting student marks, a key concept in EduTrack's efficiency.*`;

            output.textContent = demoReport;
            console.log(demoReport);
        };

        // 9. Custom Message Box (replacing alert/confirm)
        function showMessage(message, type) {
            const isError = type === 'error';
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function showConfirmation(message, onConfirm) {
             // Simple modal implementation for confirmation (replaces confirm())
             const modalHTML = `
                <div id="customConfirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancel" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancel</button>
                            <button id="confirmOk" class="py-2 px-4 border border-transparent rounded-lg text-white bg-red-600 hover:bg-red-700">Confirm Delete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = document.getElementById('customConfirmModal');

            document.getElementById('confirmCancel').onclick = () => modal.remove();
            document.getElementById('confirmOk').onclick = () => {
                onConfirm();
                modal.remove();
            };
        }
        
        // 10. Gemini API Utilities with Exponential Backoff
        async function callGeminiApiWithRetry(payload) {
            const maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        } else {
                             throw new Error("Gemini API response format invalid or empty content.");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error - retry
                        if (i < maxRetries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential backoff
                            continue;
                        } else {
                            throw new Error(`Gemini API failed after ${maxRetries} attempts with status: ${response.status}`);
                        }
                    } else {
                        // Other non-retryable error (e.g., 400 Bad Request)
                        const errorBody = await response.json();
                        throw new Error(`Gemini API error: ${response.status} - ${JSON.stringify(errorBody)}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                         throw error; // Re-throw the error after max retries
                    }
                    // Continue loop for retry on network/transient errors
                }
            }
        }
        
        // 11. AI Report Drafting Feature
        window.draftPerformanceReport = async (id) => {
            const output = document.getElementById('demoOutput');
            const student = allStudents.find(s => s.id === id);

            if (!student) {
                output.textContent = "Error: Student record not found.";
                return;
            }
            
            output.textContent = `Drafting AI Performance Summary for ${student.name}... Please wait.`;

            const systemPrompt = `You are a departmental administrative assistant. Your task is to draft a concise, formal performance summary for the given student data. The summary must be professional, constructive, and focus on two key metrics: Mathematics Marks and Attendance Percentage. Do not include salutations or sign-offs.`;
            
            const userQuery = `Draft a performance summary for the following student:\n
Student Name: ${student.name}
Roll Number: ${student.rollNo}
Mathematics Marks: ${student.mathsMarks}%
Attendance: ${student.attendance}%`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const draft = await callGeminiApiWithRetry(payload);
                output.textContent = `--- AI Generated Performance Summary for ${student.name} ---\n\n${draft}`;
                showMessage(`AI Draft generated successfully!`, 'success');
            } catch (error) {
                console.error("Gemini API call failed:", error);
                output.textContent = `AI Draft failed: Could not connect to the model or process the request. (Error: ${error.message}).`;
                showMessage('Failed to generate AI report.', 'error');
            }
        };


        // Utility: Sorting functions for demonstration
        function timeSort(arr, sortFn) {
            const start = performance.now();
            sortFn([...arr]); // Sort a copy
            const end = performance.now();
            return end - start;
        }

        function bubbleSort(arr) {
            let n = arr.length;
            for (let i = 0; i < n - 1; i++) {
                for (let j = 0; j < n - 1 - i; j++) {
                    if (arr[j] > arr[j + 1]) {
                        [arr[j], arr[j + 1]] = [arr[j + 1], arr[j]];
                    }
                }
            }
            return arr;
        }

        function quickSort(arr) {
            if (arr.length <= 1) return arr;
            let pivot = arr[Math.floor(arr.length / 2)];
            let less = [];
            let equal = [];
            let greater = [];
            for (let val of arr) {
                if (val < pivot) less.push(val);
                else if (val > pivot) greater.push(val);
                else equal.push(val);
            }
            return [...quickSort(less), ...equal, ...quickSort(greater)];
        }


        // Initialize on load
        window.onload = initializeFirebase;
    </script>
</body>
</html>